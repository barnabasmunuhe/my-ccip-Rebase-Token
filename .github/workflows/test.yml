name: Foundry CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # RPC URLs stored as GitHub secrets
      SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL || '' }}
      ARB_SEPOLIA_RPC_URL: ${{ secrets.ARB_SEPOLIA_RPC_URL || '' }}
      FOUNDRY_PROFILE: ci

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Foundry
        run: |
          # Install foundryup
          curl -L https://foundry.paradigm.xyz | bash
          # Run the installer immediately
          ~/.foundry/bin/foundryup
          # Make forge, cast, etc. available in this workflow
          export PATH="$HOME/.foundry/bin:$PATH"

      - name: Normalize line endings
        run: find . -type f -name "*.sol" -exec dos2unix {} \;

      - name: Install dependencies
        run: forge install

      - name: Apply formatting
        run: forge fmt

      - name: Check formatting
        run: forge fmt --check

      - name: Compile contracts
        run: forge build

      - name: Run tests
        run: forge test -vvv
